<!DOCTYPE html>
<html lang="ko" ng-app="MonitoringApp">
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ENS Monitoring</title>
    <link rel="stylesheet" href="/css/angular-material.1.1.8.min.css">
    <link rel="stylesheet" href="/css/flatpickr.min.css">
    <link rel="stylesheet" href="/css/ui-grid.css">
    <link rel="stylesheet" href="/css/ens.css">
</head>

<body>
    <div ng-controller="ToolbarCtrl" ng-cloak>
        <div layout="column" ng-cloak="" class="sidenavdemoCustomSidenav">
            <section layout="row" flex="">
                <md-sidenav class="md-sidenav-left" md-component-id="left" md-disable-backdrop="" md-whiteframe="4">

                    <md-toolbar class="md-theme-indigo">
                        <div>
                            <h1 class="md-toolbar-tools">가열로 List <md-icon md-svg-icon="/img/cancel.svg" ng-click="toggleLeft()"></md-icon></h1>
                        </div>
                    </md-toolbar>

                    <md-content layout-margin="">
                        <md-list-item class="md-3-line" ng-repeat="item in MenuList" ng-click="pageChange($event, item)">
                            <div class="md-list-item-text" layout="column"  >
                                <div ng-value={{item.urls}}><md-icon md-svg-icon={{item.icon_img}}></md-icon>{{ item.name }}</div>
                            </div>
                        </md-list-item>
                        <md-list-item class="md-3-line sub-list-item" ng-repeat="item in HFlist" ng-click="HFhistory($event, item)">
                            <div class="md-list-item-text" layout="column" >
                                <div ng-value={{item.HFid}}><md-icon md-svg-icon="/img/fire.svg"></md-icon>{{ item.name }}</div>
                            </div>
                        </md-list-item>
                    </md-content>

                </md-sidenav>
            </section>
        </div>
        <md-content>
            <md-toolbar class="md-hue-2">
                <div class="md-toolbar-tools">
                    <md-button class="md-icon-button" aria-label="Menu" ng-click="toggleLeft()">
                        <md-icon md-svg-icon="/img/menu.svg"></md-icon>
                    </md-button>
                    <h2 flex md-truncate>ENS - Taewoong System Monitoring</h2>
                    <md-button class="md-icon-button" aria-label="Alarm" >
                        <md-icon md-svg-icon="/img/alarm.svg"></md-icon>
                    </md-button>
                    <div>
                        {{date | date:'yyyy-MM-dd HH-mm-ss'}}
                    </div>
                </div>
            </md-toolbar>
            <br>
        </md-content>
    </div>

    <div class="GraphForm" ng-controller="GraphCtrl">
        <div class="GraphContainer">
            <div>
                <h3>가열로 {{heatingFurnaceNumber}}호기 이력 검색</h3>
            </div>
            <div class="Calendar-Container">
                <div class="Calendar-Form">
                    <input class="flatpickr flatpickr-input active" type="text" id="startInput" ng-model="pickDateTime.start"  readonly="readonly">
                </div>
                <strong class="CalendarGap">~</strong>
                <div class="Calendar-Form">
                    <input class="flatpickr flatpickr-input active" type="text" id="endInput" ng-model="pickDateTime.end"  readonly="readonly">
                </div>
                <div class="Calendar-Form">
                    <md-button class="md-raised md-primary searchBtn" ng-click="serchData()">Search</md-button>
                </div>
            </div>
            <md-progress-circular md-mode="indeterminate" md-diameter="80" ng-show="isLoading" ></md-progress-circular>
            <div class="Graph-Frame" id="historyGraph" >
                
            </div>
        </div>
        <hr/>
        <div class="GridContainer">
            <div class="grid" id="grid1" ui-grid="historyGridOpts" ></div>
        </div>
    </div>
    
    
</body>
    
    <!-- Angular.js Libraries -->
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular-touch.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular-animate.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.7.0/angular-aria.js"></script>
    <!-- UI-Grid.js Libraries -->
    <script src="http://ui-grid.info/docs/grunt-scripts/csv.js"></script>
    <script src="http://ui-grid.info/docs/grunt-scripts/pdfmake.js"></script>
    <script src="http://ui-grid.info/docs/grunt-scripts/vfs_fonts.js"></script>
    <script src="http://ui-grid.info/docs/grunt-scripts/lodash.min.js"></script>
    <script src="http://ui-grid.info/docs/grunt-scripts/jszip.min.js"></script>
    <script src="http://ui-grid.info/docs/grunt-scripts/excel-builder.dist.js"></script>
    <script src="http://ui-grid.info/release/ui-grid.js"></script>
    <!-- Angular Material Library -->
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.js"></script>
    <script type="text/javascript" src="/js/echarts.min.js"></script>
    <script type="text/javascript" src="/js/flatpickr.js"></script>
    <!--<script type="text/javascript" src="/js/ui-grid.js"></script>-->


    <script type="text/javascript">
        var myApp = angular.module('MonitoringApp', ['ngMaterial', 'ui.grid']);
        
        myApp.controller('ToolbarCtrl', function($scope, $interval, $mdSidenav, $window, $location) {
            $interval(function(){
                $scope.date = new Date();
            },1000);

            $scope.toggleLeft = buildToggler('left');
            function buildToggler(componentId) {
                return function() {
                    $mdSidenav(componentId).toggle();
                };
            }

            $scope.MenuList = [
                { name : '전체 모니터링', urls : 'main', icon_img: '/img/monitor.svg'},
                { name : '가열로 이력 검색', urls : 'history', icon_img : '/img/history.svg'}
            ];

            $scope.HFlist = [
                {
                    name : '가열로 1호기',
                    HFid: '1',
                },{
                    name : '가열로 2호기',
                    HFid: '2',
                },{
                    name : '가열로 3호기',
                    HFid: '3',
                },{
                    name : '가열로 4호기',
                    HFid: '4',
                },{
                    name : '가열로 5호기',
                    HFid: '5',
                }
            ];
            $scope.HFhistory = function(event, item){
                var linkURL = "http://" + $window.location.host + "/history/" +item.HFid;
                $window.location.href = linkURL;
            };
            $scope.pageChange = function(event, item){
                var linkURL = "http://" + $window.location.host + "/" +item.urls;
                $window.location = linkURL;
            }
        });  


        myApp.controller('GraphCtrl', function($scope, $http, $interval, $timeout, $window, $location){
            $scope.heatingFurnaceNumber = $window.location.pathname.substring(9,10);
            $scope.isLoading = true;    // 그래프 데이터 로딩 프로그레스바
            var basicDateTimeLen = 120; //이력 조회 첫화면에는 현재 시간기준 2시간 전 까지의 데이터 조회
            var historyData = [];
            var columDef = [
                { field: 'Time' , displayName : '시간' },
                { field: 'Gas_CumUsage' , displayName : '가스 누적지침' },
                { field: 'Gas' , displayName : '가스 사용량' },
                { field: 'Elect_CumUsage' , displayName : '전력 누적지침' },
                { field: 'Electricity' , displayName : '전력 사용량(kWh)' },
                { field: 'Temperature1' , displayName : '온도계1(°C)' },
                { field: 'Temperature2' , displayName : '온도계2(°C)' }
            ];
            
            $scope.historyGridOpts = {
                columnDefs: columDef,
                enableRowSelection: true, 
                enableRowHeaderSelection: false,
                data : historyData
            };

            if($scope.heatingFurnaceNumber == ''){
                $scope.heatingFurnaceNumber = 1;
            }

            var gasAmount = [];
            var electAmount = [];
            var temperAmount = [];
            var timestamps = [];

            for(var i=basicDateTimeLen; i>=0; i--){
                var convertedTime = setDateTime(i);
                timestamps.push(convertedTime);
            }
        
            
            $scope.pickDateTime={
                start : timestamps[0],
                end : timestamps[basicDateTimeLen]
            };

            var fstart = flatpickr("#startInput", {
                enableTime: true, 
                dateFormat: "Y-m-d H:i",
                disableMobile: true,
                time_24hr: true,
                defaultDate : $scope.pickDateTime.start
            });

            var fend = flatpickr("#endInput", {
                enableTime: true, 
                dateFormat: "Y-m-d H:i",
                disableMobile: true,
                time_24hr: true,
                defaultDate : $scope.pickDateTime.end
            });

            $scope.serchData = function(){
                gasAmount = [];
                electAmount = [];
                temperAmount = [];
                timestamps = [];
                $scope.isLoading = true;
                var dom = document.getElementById('historyGraph');
                var myChart = echarts.dispose(dom);
                var setStartTime = new Date(convertTime($scope.pickDateTime.start, 1));
                var setEndTime = new Date($scope.pickDateTime.end);
                var timeGap = (setEndTime - setStartTime)/(1000*60);
                for(var i=timeGap-1; i>0; i--){
                    var convertedTime = convertTime($scope.pickDateTime.end, i);
                    timestamps.push(convertedTime);
                    $scope.historyGridOpts.data.push({'Time' : convertedTime});
                }
                $scope.getGasInfo();
            }
            
            function setDateTime(sec){
                //var nowDate = new Date( new Date('2018-12-24 10:00')-(1000*60*sec) );
                var nowDate = new Date( new Date()-(1000*60*sec) );
                var months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
                var year = nowDate.getFullYear();
                var month = months[nowDate.getMonth()];
                var date = (nowDate.getDate()<10?'0':'')+nowDate.getDate();
                var hour = (nowDate.getHours()<10?'0':'')+nowDate.getHours();
                var min = (nowDate.getMinutes()<10?'0':'')+nowDate.getMinutes();
                return year+'-'+month+'-'+date+' '+ hour + ':' + min;
            }

            function convertTime(dTime, sec){
                var sTime = new Date(new Date(dTime)-1000*60*sec);
                var months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
                var year = sTime.getFullYear();
                var month = months[sTime.getMonth()];
                var date = (sTime.getDate()<10?'0':'')+sTime.getDate();
                var hour = (sTime.getHours()<10?'0':'')+sTime.getHours();
                var min = (sTime.getMinutes()<10?'0':'')+sTime.getMinutes();
                return year+'-'+month+'-'+date+' '+ hour + ':' + min;
            }
            
            $scope.getGasInfo = function(){
                var params = {
                    'start' : convertTime($scope.pickDateTime.start, 1),
                    'end' : $scope.pickDateTime.end
                };
                $http({
                    method  : 'POST',
                    url     : 'http://localhost:18000/Gas/'+$scope.heatingFurnaceNumber,
                    data : params,
                    config: 'Content-Type: application/json;'
                }).
                then(function successCallback(response) {
                    gasAmount = [];
                    var gasUsage = [];
                    gasUsage[timestamps.length-1] = 0;
                    var gasTotal = [];
                    gasTotal[timestamps.length-1] = 0;
                    var dateIndex = 0;

                    for (var i = 1 ; i < response.data.length ; i++) {
                        var index = timestamps.indexOf(response.data[i].createdAt);
                        gasUsage[index] = (response.data[i].value - response.data[i-1].value) / 10;
                        gasTotal[index] = response.data[i].value / 10;
                    }
                    gasAmount.push({
                        'usage' : gasUsage,
                        'total' : gasTotal
                    });
                    $scope.getElectricityInfo();
                },function errorCallback(response) {
                  console.log('error occuring : getGasInfo=function');
                });
            }

            $scope.getElectricityInfo = function(){
                var params = {
                    'start' : convertTime($scope.pickDateTime.start, 1),
                    'end' : $scope.pickDateTime.end
                };
                $http({
                    method  : 'POST',
                    url     : 'http://localhost:18000/Electricity/'+$scope.heatingFurnaceNumber,
                    data : params,
                    config: 'Content-Type: application/json;'
                }).
                then(function successCallback(response) {
                    electAmount = [];
                    var electUsage = [];
                    electUsage[timestamps.length-1] = 0;
                    var electTotal = [];
                    electTotal[timestamps.length-1] = 0;
                    var dateIndex = 0;

                    for (var i = 1 ; i < response.data.length ; i++) {
                        var index = timestamps.indexOf(response.data[i].createdAt);
                        electUsage[index] = (response.data[i].value - response.data[i-1].value).toFixed(2);
                        electTotal[index] = response.data[i].value.toFixed(2);
                    }
                    electAmount.push({
                        'usage' : electUsage,
                        'total' : electTotal
                    });
                    $scope.getTemperature1();
                },function errorCallback(response) {
                  console.log('error occuring : electricityInfo=function');
                });
            }

            $scope.getTemperature1 = function(){
                var params = {
                    'start' : convertTime($scope.pickDateTime.start, 1),
                    'end' : $scope.pickDateTime.end,
                    'tKind' : '1'
                };
                $http({
                    method  : 'POST',
                    url     : 'http://localhost:18000/Temperature/'+$scope.heatingFurnaceNumber,
                    data : params,
                    config: 'Content-Type: application/json;'
                }).
                then(function successCallback(response) {
                    temperAmount = [];
                    var temper1Usage = [];
                    temper1Usage[timestamps.length-1] = 0;
                    var dateIndex = 0;

                    for (var i = 1 ; i < response.data.length ; i++) {
                        var index = timestamps.indexOf(response.data[i].createdAt);
                        temper1Usage[index] = response.data[i].value/10;
                    }
                    temperAmount.push({
                        'temper1' : temper1Usage
                    });
                    $scope.getTemperature2();
                },function errorCallback(response) {
                  console.log('error occuring : getTemperature1=function');
                });
            }

            $scope.getTemperature2 = function(){
                var params = {
                    'start' : convertTime($scope.pickDateTime.start, 1),
                    'end' : $scope.pickDateTime.end,
                    'tKind' : '2'
                };
                $http({
                    method  : 'POST',
                    url     : 'http://localhost:18000/Temperature/'+$scope.heatingFurnaceNumber,
                    data : params,
                    config: 'Content-Type: application/json;'
                }).
                then(function successCallback(response) {
                    var temper2Usage = [];
                    temper2Usage[timestamps.length-1] = 0;
                    var dateIndex = 0;

                    for (var i = 1 ; i < response.data.length ; i++) {
                        var index = timestamps.indexOf(response.data[i].createdAt);
                        temper2Usage[index] = response.data[i].value/10;
                    }
                    temperAmount.push({
                        'temper2' : temper2Usage
                    });
                    $scope.isLoading = false;
                    setGraphData();
                },function errorCallback(response) {
                  console.log('error occuring : getTemperature2=function');
                });
            }

            // funtion setGraphData()
            // 설명 : 그래프를 그리기 위한 정보를 Set 하는 함수
            function setGraphData(){
                var colors = ['#009966', '#0000FF', '#CC6600'];
                var dom = document.getElementById('historyGraph');
                var myChart = echarts.init(dom);
                var app = {};
                option = {
                    tooltip: {
                        trigger: 'axis',
                        position: function (pt) {
                            return [pt[0], '10%'];
                        }
                    },
                    grid: {
                        right: '20%'
                    },
                    toolbox: {
                        feature: {
                            dataZoom: {
                                yAxisIndex: 'none'
                            },
                            dataView: {show: true, readOnly: false},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    legend: {
                        data:['가스','전력','온도1','온도2']
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        axisTick: {
                            alignWithLabel: true
                        },
                        data: timestamps
                    },
                    yAxis: [
                        {
                            type: 'value',
                            boundaryGap: [0, '1%'],
                            position: 'left',
                            name : '가스량(m3)',
                            nameTextStyle :{
                                fontWeight : 'bold'
                            }
                        },{
                            type: 'value',
                            position: 'right',
                            name : '전력량(kWh)',
                            axisLine: {
                                lineStyle: {
                                    color: colors[0]
                                }
                            },
                            axisLabel: {
                                formatter: '{value} kWh'
                            },
                            nameTextStyle :{
                                fontWeight : 'bold'
                            }
                        },{
                            type: 'value',
                            position: 'right',
                            name : '온도1(C)',
                            offset: 80,
                            min: 0,
                            max: 1500,
                            axisLine: {
                                lineStyle: {
                                    color: colors[1]
                                }
                            },
                            axisLabel: {
                                formatter: '{value} °C'
                            },
                            nameTextStyle :{
                                fontWeight : 'bold'
                            }
                        },{
                            type: 'value',
                            position: 'right',
                            name : '온도2(C)',
                            offset: 150,
                            min: 0,
                            max: 1500,
                            axisLine: {
                                lineStyle: {
                                    color: colors[2]
                                }
                            },
                            axisLabel: {
                                formatter: '{value} °C'
                            },
                            nameTextStyle :{
                                fontWeight : 'bold'
                            }
                        }
                    ],
                    dataZoom: [{
                        type: 'inside',
                        start: 80,
                        end: 100
                    }, {
                        start: 0,
                        end: 10,
                        handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#fff',
                            shadowBlur: 3,
                            shadowColor: 'rgba(0, 0, 0, 0.6)',
                            shadowOffsetX: 2,
                            shadowOffsetY: 2
                        }
                    }],
                    series: [
                        {
                            name:'가스',
                            type:'line',
                            smooth:true,
                            symbol: 'circle',
                            symbolSize: [6,6],
                            sampling: 'average',
                            itemStyle: {
                                color: 'rgb(255, 70, 131)'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: 'rgb(255, 158, 68)'
                                }, {
                                    offset: 1,
                                    color: 'rgb(255, 70, 131)'
                                }])
                            },
                            data: gasAmount[0].usage
                        },
                        {
                            name:'전력',
                            type:'line',
                            yAxisIndex: 1,
                            itemStyle: {
                                color: colors[0]
                            },
                            axisLine: {
                                lineStyle: {
                                    color: colors[0]
                                }
                            },
                            data: electAmount[0].usage
                        },{
                            name:'온도1',
                            type:'line',
                            yAxisIndex: 2,
                            itemStyle: {
                                color: colors[1]
                            },
                            axisLine: {
                                lineStyle: {
                                    color: colors[1]
                                }
                            },
                            data: temperAmount[0].temper1
                        },{
                            name:'온도2',
                            type:'line',
                            yAxisIndex: 3,
                            itemStyle: {
                                color: colors[2]
                            },
                            axisLine: {
                                lineStyle: {
                                    color: colors[2]
                                }
                            },
                            data: temperAmount[1].temper2
                        }
                    ]
                };
                
                if (option && typeof option === "object") {
                    myChart.setOption(option, true);
                }
                setGridData();
            }
            
            function setGridData(){
                $scope.historyGridOpts.data = [];
                for(var i=timestamps.length-1; i>=0; i--){
                    var gas_cumusage = (typeof gasAmount[0].total[i]) != 'undefined' ? gasAmount[0].total[i] : '0';
                    var gas_usage = (typeof gasAmount[0].usage[i]) != 'undefined' ? gasAmount[0].usage[i] : '0';
                    var elect_cumusage = (typeof electAmount[0].total[i]) != 'undefined' ? electAmount[0].total[i] : '0';
                    var elect_usage = (typeof electAmount[0].usage[i]) != 'undefined' ? electAmount[0].usage[i] : '0';
                    var temper1 = (typeof temperAmount[0].temper1[i]) != 'undefined' ? temperAmount[0].temper1[i] : '0';
                    var temper2 = (typeof temperAmount[1].temper2[i]) != 'undefined' ? temperAmount[1].temper2[i] : '0';
                    
                    $scope.historyGridOpts.data.push({
                        'Time' : timestamps[i],
                        'Gas_CumUsage' : gas_cumusage,
                        'Gas' : gas_usage,
                        'Elect_CumUsage' : elect_cumusage,
                        'Electricity' : elect_usage,
                        'Temperature1' : temper1,
                        'Temperature2' : temper2
                    });
                }
            }

            $scope.getGasInfo();
        });
        
    </script>
</html>